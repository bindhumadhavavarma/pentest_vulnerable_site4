
<?php
function generateCaptcha() {
    // Generate the captcha code and image
    // ...

    $width = 200;
    $height = 50;
    $fontFile = __DIR__ . '/arial.ttf';
    $fontSize = 24;
    
    $image = imagecreatetruecolor($width, $height);
    $bgColor = imagecolorallocate($image, 255, 255, 255);
    imagefill($image, 0, 0, $bgColor);
    
    // Generate random noise
    $noiseColor = imagecolorallocate($image, 0, 0, 0);
    for ($i = 0; $i < $width; $i++) {
        for ($j = 0; $j < $height; $j++) {
            if (rand(0, 100) < 25) { // 10% chance of adding noise
                imagesetpixel($image, $i, $j, $noiseColor);
            }
        }
    }
    
    // Generate random string
    $captchaLength = 6;
    $captchaChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    $captchaString = '';
    for ($i = 0; $i < $captchaLength; $i++) {
        $captchaString .= $captchaChars[rand(0, strlen($captchaChars) - 1)];
    }
    
    // Add text to image
    $textColor = imagecolorallocate($image, 0, 0, 0);
    $x = $width / $captchaLength;
    for ($i = 0; $i < $captchaLength; $i++) {
        $angle = rand(-15, 15);
        imagettftext($image, $fontSize, $angle, $x * $i + rand(5, 10), rand($fontSize, $height - 10), $textColor, $fontFile, $captchaString[$i]);
    }
    ob_start();
    imagepng($image);
    $imageString = ob_get_clean();
    
    return [
        'code' => $captchaString,
        'image' => base64_encode($imageString),
    ];
}

?>
<!DOCTYPE html>
<html lang="en">

<head>
    <title>Login page</title>
    <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="css/login.css">
    <meta charset="ISO-8859-1">
</head>

<body>
    <?php require 'view/components/info_to_user.php' ?>
    <div class="container-fluid ps-md-0">
        <div class="row g-0">
            <div class="d-none d-md-flex col-md-4 col-lg-6 bg-image"></div>
            <div class="col-md-8 col-lg-6">
                <div class="login d-flex align-items-center py-5">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-9 col-lg-8 mx-auto">
                                <h3 class="login-heading mb-4">Welcome to APTS Messaging!</h3>
                                <form action="index.php?action=login" method="post">
                                    <div class="form-floating mb-3">
                                        <input name="fLogin" type="text" class="form-control" id="floatingUsername"
                                            placeholder="Username">
                                        <label for="floatingUsername">Username</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <input name="fPasswd" type="password" class="form-control" id="floatingPassword"
                                            placeholder="Password">
                                        <label for="floatingPassword">Password</label>
                                    </div>
                                    <div class="form-floating mb-3">
                                        <div class="col-md-5 mt-4">
                                            <?php
                                            $captcha = generateCaptcha();
                                            $_SESSION['captcha'] = $captcha['code'];
                                            echo '<img src="data:image/png;base64,' . $captcha['image'] . '" height="50px" />';
                                            ?>
                                        </div>
                                        <div class="form-group col-md-7">
                                            <label for="exampleInputPassword1">Captcha</label>
                                            <input type="text" class="form-control" id="exampleInputPassword1"
                                                name="captcha" required>
                                        </div>
                                    </div>
                                    <div class="d-grid">
                                        <button class="btn btn-lg btn-primary btn-login text-uppercase fw-bold mb-2"
                                            type="submit">Sign in</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>